所谓的“代理服务”就是指服务本身不生产内容，而是处于中间位置转发上下游的请求和响应，具有双重身份：面向下游的用户时，表现为服务器，代表源服务器响应客户端的请求；而面向上游的源服务器时，又表现为客户端，代表客户端发送请求。

代理有很多的种类，例如匿名代理、透明代理、正向代理和反向代理。这里讲的是是实际工作中最常见的反向代理，它在传输链路中更靠近源服务器，为源服务器提供代理服务。

# 代理的作用
> 计算机科学领域里的任何问题，都可以通过引入一个中间层来解决

由于代理处在 HTTP 通信过程的中间位置，相应地就对上屏蔽了真实客户端，对下屏蔽了真实服务器，简单的说就是“欺上瞒下”。在这个中间层的“小天地”里就可以做很多的事情，**为 HTTP 协议增加更多的灵活性**，实现客户端和服务器的“双赢”。
## 1、负载均衡
![](https://static001.geekbang.org/resource/image/8c/7c/8c1fe47a7ca4b52702a6a14956033f7c.png)

代理中常用的负载均衡算法有，轮询、一致性哈希等等，这些算法的目标都是尽量把外部的流量合理地分散到多台源服务器，提高系统的整体资源利用率和性能。

## 2、其他功能
- **健康检查**：使用心跳等机制监控后端服务器，发现有故障就及时“踢出”集群，保证服务高可用。
- **安全防护**：保护被代理的后端服务器，限制IP地址或流量，低于网络攻击和过载。
- **加密卸载**：对外网使用 SSL/TLS 加密通信认证，而在安全的内容不加密，消除加解密成本。
- **数据过滤**：拦截上下行的数据，任意指定策略修改请求或响应。
- **内容缓存**：暂存、复用服务器响应。

# 代理相关头字段

## Via
代理服务器需要用字段“**Via**”标明代理的身份。

Via 是一个通用字段，请求头或响应头里都可以出现。每当报文经过一个代理节点，代理服务器就会把自身的信息追加到字段的末尾，就像是经手人盖了一个章。

![](https://static001.geekbang.org/resource/image/52/d7/52a3bd760584972011f6be1a5258e2d7.png)

## X-Forwarded-For 和 X-Real-IP

“X-Forwarded-For”追加的是请求方的 IP 地址。所以，在字段里最左边的 IP 地址就是客户端的地址。

“X-Real-IP”是另一种获取客户端真实 IP 的手段，它的作用很简单，就是记录客户端 IP 地址，没有中间的代理信息.

# 代理协议
有了“X-Forwarded-For”等头字段，源服务器就可以拿到准确的客户端信息了。但对于代理服务器来说它并不是一个最佳的解决方案。

因为通过“X-Forwarded-For”操作代理信息必须要解析 HTTP 报文头，这对于代理来说成本比较高，原本只需要简单地转发消息就好，而现在却必须要费力解析数据再修改数据，会降低代理的转发性能。

另一个问题是“X-Forwarded-For”等头必须要修改原始报文，而有些情况下是不允许甚至不可能的（比如使用 HTTPS 通信被加密）。

所以就出现了一个专门的“代理协议”（The PROXY protocol）。

代理协议的 v1，它在 HTTP 报文前增加了一行 ASCII 码文本，相当于又多了一个头。

这一行文本其实非常简单，开头必须是“PROXY”五个大写字母，然后是“TCP4”或者“TCP6”，表示客户端的 IP 地址类型，再后面是请求方地址、应答方地址、请求方端口号、应答方端口号，最后用一个回车换行（\r\n）结束。

```
PROXY TCP4 1.1.1.1 2.2.2.2 55555 80\r\n
GET / HTTP/1.1\r\n
Host: www.xxx.com\r\n
\r\n
```

服务器看到这样的报文，只要解析第一行就可以拿到客户端地址，不需要再去理会后面的 HTTP 数据，省了很多事情。不过代理协议并不支持“X-F