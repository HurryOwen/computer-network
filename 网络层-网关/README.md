# 2.网关
在任何一台机器上，当要访问另一个 IP 时，都会先判断，这个目标 IP 和当前机器的 IP 是否在同一个网段（通过CIDR和子网掩码判断）。
- **如果是同一个网段**，直接将源地址和目标地址放入 IP 头中，然后通过 ARP 获得 MAC 地址，将源 MAC 和目的 MAC 放入 MAC 头中，发出去就可以。
- **如果是同一个网段**，要把包发给**网关 Gateway**， 网关的地址一定和源 IP 是一个网段的。通常是该网段的第一个地址。

网关往往是一个路由器，是一个三层转发的设备。就是把 MAC 头和 IP 头都取下来，然后根据里面的内容，看看接下来把包往哪里转发的设备。

路由器是一台设备，它上面可以有多个网口或网卡，分别连接不同的局域网，每个网卡都是它连着的那个局域网的网关。

## 转发网关和 NAT 网关
MAC 地址是一个局域网内才有效的地址。因此只要经过网关，就必定要改变 MAC 地址。

转发网关和 NAT 网关的区别在于 IP 地址是否改变。**不改变 IP 地址的网关叫转发网关；改变 IP 地址的网关叫 NAT 网关。**

## 网段不冲突，IP 头不变
如果通信过程中的的局域网之间的网段不冲突，那在传输过程中，IP 头不改变。

如下示例：
![](https://static001.geekbang.org/resource/image/35/3b/35fb548bbaa7d77012ab46151bfbe63b.jpg)

服务器 A 要访问服务器 B：

第一步，服务器 A 知道自己跟服务器 B 不在一个网段，因此会把请求发给默认网关，网关的 MAC 地址通过 ARP 获取。包内容如下：
```
源 MAC: 服务器 A 的 MAC
目标 MAC: 192.168.1.1 这个网口的 MAC
源 IP: 服务器 A 192.168.1.101
目标 IP: 服务器 B 192.168.4.101
```
第二步，包到达 `192.168.1.1` 这个网口，发现 MAC 一致，将包收进来，通过静态路由规则知道，要想访问 `192.168.4.0/24` ，要从 `192.168.56.1` 这个口出去，下一跳是 `192.168.56.2`，于是发包：
```
源 MAC: 192.168.56.1 网口 的 MAC
目标 MAC: 192.168.56.2 网口的 MAC
源 IP: 服务器 A 192.168.1.101
目标 IP: 服务器 B 192.168.4.101
```
第三步，包到达 `192.168.56.2` 这个网口，发现 MAC 一致，将包收进来，通过静态路由规则知道，要想访问 `192.168.4.0/24`，要从 `192.168.4.1` 这个口出去，由于 `192.168.4.1` 这个口就是 `192.168.4.0/24` 这个网段的，所以没有下一跳。直接发送包给目标 IP：
```
源 MAC: 192.168.4.1 网口 的 MAC
目标 MAC: 服务器 B 192.168.4.101 的 MAC
源 IP: 服务器 A 192.168.1.101
目标 IP: 服务器 B 192.168.4.101
```

## 网段冲突，IP 头改变
如果通信过程中的的局域网之间的网段冲突，那在传输过程中需要 NAT 网关，将内网 IP 转为 公网 IP，IP 头会改变。

有网段冲突的局域网之间通信，是根据公网 IP 来通信的。所以在网关 A 和 网关 B 上都至少有一个 公网 IP，并且网关上的映射表记录着各自内网 IP 与公网 IP 的对应关系。

如下示例：
![](https://static001.geekbang.org/resource/image/35/3b/35fb548bbaa7d77012ab46151bfbe63b.jpg)

第一步，原服务器 A `192.168.1.101` 要访问目标地址 `192.168.56.2`，考虑到不是一个网段，于是把包发给网关 `192.168.1.1`，包内容如下：
```
源 MAC：服务器 A 的 MAC
目标 MAC：192.168.1.1 这个网口的 MAC
源 IP：服务器 A 192.168.1.101
目标 IP：192.168.56.2
```
第二步，包到达 `192.168.1.1` 这个网口，发现 MAC 一致，将包收进来，通过静态路由规则知道，要想访问 `192.168.56.2/24`，要从 `192.168.56.1` 这个口出去，没有下一跳。发送包给目标 IP:
```
源 MAC：192.168.56.1 的 MAC 地址
目标 MAC：192.168.56.2 的 MAC 地址
源 IP：192.168.56.1
目标 IP：192.168.56.2
```
第三步，包到达 `192.168.56.2` 这个网口，发现 MAC 一致，将包收进来，通过映射表知道，`192.168.56.2` 对应的内网 ip `192.168.1.101`，于是改为访问 `192.168.1.101`。通过静态路由规则知道，要想访问 `192.168.1.0/24`，要从 `192.168.1.1` 这个口出去，没有下一跳。包内容如下：
```
源 MAC：192.168.1.1 的 MAC 地址
目标 MAC：192.168.1.101 的 MAC 地址
源 IP：192.168.56.1
目标 IP：192.168.1.101
```

传输过程中改变 IP 的过程用英文说就是 **Network Address Translation**，简称 **NAT**。

## 总结
- 如果离开本局域网，就需要经过网关，网关是路由器的一个网口；
- 路由器是一个三层设备，里面有如何寻找下一跳的规则；
- 经过路由器之后 MAC 头要变，如果网段不冲突，通过转发网关，IP 无需改变。如果网段冲突，则要通过 NAT 网关映射成公网 IP。