# ICMP
## ICMP 协议格式
ping 是基于 **ICMP** 协议工作的。ICMP 全称 Internet Control Message Protocol，就是**互联网控制报文协议**。

ICMP 报文是封装在 IP 包里面的。因为传输指令的时候，肯定需要源地址和目标地址。

![](https://static001.geekbang.org/resource/image/20/e2/201589bb205c5b00ad42e0081aa46fe2.jpg)

## 查询报文类型
常用的 **ping 就是查询报文，是一种主动请求，并且获得主动应答的 ICMP 协议。**

最常用的类型是主动请求为 8，主动请求的应答为 0。

## 差错报文类型
- 终点不可达，代码为 3
- 源抑制，代码为 4
- 时间超时，代码为 11
- 路由重定向，代码为 5

## Traceroute: 差错报文类型的使用
**Traceroute 的第一个作用就是故意设置特殊的 TTL，来追踪去往目的地时沿途经过的路由器。**Traceroute 的参数指向某个目的 IP 地址，它会发送一个 UDP 的数据包。将 TTL 设置成 1，也就是说一旦遇到一个路由器，就返回一个ICMP 网络差错宝，类型是时间超时。接下来将 TTL 设置成 2，同样就知道第二个路由器了，如此反复，直到到达目的主机。

当然，有的路由器压根不会回这个 ICMP。这也是 Traceroute 一个公网的地址，看不到中间路由的原因。

**TTL是网络包里的一个值，它告诉路由器包在网络中太长时间是否需要被丢弃。**TTL最初的设想是，设置超时时间，超过此范围则被丢弃。每个路由器要将TTL减一，TTL通常表示被丢弃前经过的路由器的个数。当TTL变为0时，该路由器丢弃该包，并发送一个ICMP包给最初的发送者。 

**怎么知道 UDP 有没有到达目的主机呢？**
Traceroute 程序会发送一份 UDP 数据报给目的主机，但它会选择一个不可能的值作为 UDP 端口号（大于 30000）。当该数据报到达时，将使目的主机的 UDP 模块产生一份“端口不可达”错误 ICMP 报文。如果数据报没有到达，则可能是超时。


**Traceroute 还有一个作用是故意设置不分片，从而确定路径的 MTU。**

## 总结
- ICMP 相当于网络世界的侦察兵。主要有两种类型的 ICMP 报文，一种是主动探查的查询报文，一种异常报告的差错报文；
- ping 使用查询报文，Traceroute 使用差错报文。