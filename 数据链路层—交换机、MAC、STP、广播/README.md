第一层是物理层，物理层提供设备，即数据传输的通路，将多台设备连接起来。设备如网线，接线头，hub（集线器）等。

第二层是数据链路层，也即 MAC 层，Medium Access Control，即**媒体访问控制**。

设备有网桥、交换机。

## MAC 层要解决三个问题：
1. 谁先发，谁后发？
2. 发给谁？谁接收？
3. 如果发送的时候出现了错误，怎么办？

**解决：**

1. **信道划分**，各走各的道；**轮流协议**；**随机接入协议**，错开高峰；
2. 通过 MAC 地址。
  第二层网络包格式如下：
  ![](https://static001.geekbang.org/resource/image/80/41/8072e4885b0cbc6cb5384ea84d487e41.jpg)
  对于以太网，第二层的最开始，就是**目标 MAC 地址**和**源 MAC 地址**，其中**类型**，大部分的类型是 IP 数据包，包里还包含 TCP、UDP，以及 HTTP 等，这都是里层封装的事情。

  有了这个目标 MAC 地址，数据包在链路上广播，MAC 的网卡才能发现，这个包是给它的。MAC 的网卡把包收进来，然后打开 IP 包，发现 IP 地址也是自己的，再打开 TCP 包，发现端口是自己，也就是 80，而 nginx 就是监听 80，交给 nginx 处理。

3. 数据包的最后一个**CRC**，也就是**循环冗余检测**，用来解决第三个问题

### 已知 IP， 求MAC 地址
通过 **ARP 协议** 进行广播。

### 交换机
交换机是二层设备。

交换机通过学习可以知道局域网内每个IP的 MAC 地址，学习的结果称为**转发表**，这个转发表有过期时间。

### 总结
- 第一，MAC 层是用来解决多路访问的堵车问题的；
- 第二，ARP 是**通过广播的方式**来寻找目标 MAC 地址的，机器会进行 ARP 缓存，避免每次都用 ARP 请求；
- 第三，交换机是有 MAC 地址学习能力的，学习成果为转发表，有了之后就不用广播了。

## 如何解决常见的环路问题
### STP
在计算机网络中，最小生成树的算法叫作 **STP**(Spanning Tree Protocol)。

**概念：**
- **Root Bridge**，也就是根交换机。
- **Designated Bridges**，有的翻译为指定交换机。
- **Bridge Protocol Data Units （BPDU）** ，网桥协议数据单元。
- **Priority Vector**，优先级向量

## 如何解决广播和安全问题
- 物理隔离
- **虚拟隔离**，就是用我们常说的 **VLAN**，或者叫**虚拟局域网**。
![](https://static001.geekbang.org/resource/image/ba/60/ba720f6988558f95c381f4deaab11660.jpg)

在原来的二层头上加一个 TAG，里面有一个 VLAN ID，如果交换机支持 VLAN，当交换机把二层的头取下来时，就能够识别这个 VLAN ID。只有是相同 VLAN 的包才会互相转发。

将两个交换机连接起来的口应该设置成什么 VLAN 呢？对于支持 VLAN 的交换机，有一种口叫作 **Trunk 口**。它可以转发属于任何 VLAN 的口。交换机之间可以通过这种口相互连接。

### 总结
- 当交换机越来越多时，使用 STP 协议解决环路问题
- 交换机数目多会面临隔离问题，可以通过 VLAN 形成虚拟局域网，从而解决广播问题和安全问题。